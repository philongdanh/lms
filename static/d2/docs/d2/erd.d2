# Entity Relationship Diagram
# D2 Documentation: https://d2lang.com

direction: down

# Users Domain
users: users {
  shape: sql_table
  id: uuid {constraint: primary_key}
  email: varchar(255) {constraint: unique}
  phone: varchar(20) {constraint: unique}
  password_hash: varchar(255)
  name: varchar(255)
  role: user_role
  grade: integer
  points: integer
  level: integer
  tenant_id: uuid {constraint: foreign_key}
  created_at: timestamptz
  updated_at: timestamptz
  deleted_at: timestamptz
}

user_badges: user_badges {
  shape: sql_table
  id: uuid {constraint: primary_key}
  user_id: uuid {constraint: foreign_key}
  badge_id: uuid {constraint: foreign_key}
  earned_at: timestamptz
}

badges: badges {
  shape: sql_table
  id: uuid {constraint: primary_key}
  name: varchar(100)
  description: text
  icon: varchar(50)
  criteria: jsonb
}

# Learning Domain
subjects: subjects {
  shape: sql_table
  id: uuid {constraint: primary_key}
  name: varchar(100)
  slug: varchar(100) {constraint: unique}
  icon: varchar(50)
  color: varchar(7)
  order: integer
  is_active: boolean
}

topics: topics {
  shape: sql_table
  id: uuid {constraint: primary_key}
  subject_id: uuid {constraint: foreign_key}
  name: varchar(255)
  description: text
  order: integer
  grade: integer
}

lessons: lessons {
  shape: sql_table
  id: uuid {constraint: primary_key}
  topic_id: uuid {constraint: foreign_key}
  title: varchar(255)
  content: text
  video_url: varchar(500)
  duration: integer
  order: integer
  points: integer
}

exercises: exercises {
  shape: sql_table
  id: uuid {constraint: primary_key}
  lesson_id: uuid {constraint: foreign_key}
  title: varchar(255)
  type: exercise_type
  difficulty: difficulty
  time_limit: integer
  points: integer
}

learning_progress: learning_progress {
  shape: sql_table
  id: uuid {constraint: primary_key}
  user_id: uuid {constraint: foreign_key}
  lesson_id: uuid {constraint: foreign_key}
  completed_at: timestamptz
  points_earned: integer
}

exercise_attempts: exercise_attempts {
  shape: sql_table
  id: uuid {constraint: primary_key}
  user_id: uuid {constraint: foreign_key}
  exercise_id: uuid {constraint: foreign_key}
  score: integer
  answers: jsonb
  completed_at: timestamptz
}

# Tournament Domain
tournaments: tournaments {
  shape: sql_table
  id: uuid {constraint: primary_key}
  name: varchar(255)
  description: text
  status: tournament_status
  subject_id: uuid {constraint: foreign_key}
  grade: integer
  start_time: timestamptz
  end_time: timestamptz
  max_participants: integer
  prize_pool: integer
}

tournament_participations: tournament_participations {
  shape: sql_table
  id: uuid {constraint: primary_key}
  tournament_id: uuid {constraint: foreign_key}
  user_id: uuid {constraint: foreign_key}
  status: participation_status
  score: integer
  rank: integer
  completed_at: timestamptz
}

# Relationships
users -> user_badges: has many
badges -> user_badges: has many
users -> learning_progress: has many
users -> exercise_attempts: has many
users -> tournament_participations: has many

subjects -> topics: has many
topics -> lessons: has many
lessons -> exercises: has many
lessons -> learning_progress: has many
exercises -> exercise_attempts: has many

tournaments -> tournament_participations: has many
subjects -> tournaments: has many
